name: Cypress Tests
on:
  pull_request:
    branches:
      - master

jobs:
  deploy-envs:
    name: Deploy environments
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
      matrix:
        test_env: [AppStream_Enabled,AppStream_Disabled]
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Deploy
        env:
          TEST_ENV: ${{ matrix.test_env }}
        continue-on-error: true
        run: ./deploy-in-parallel.sh

  cypress-test:
    name: Cypress tests
    needs: deploy-envs
    runs-on: ubuntu-18.04
    strategy:
      fail-fast: false
      matrix:
        test_env: [AppStream_Enabled,AppStream_Disabled]

    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 12
      - name: Install yarn and system libraries
        run: |
          npm install -g yarn
          sudo apt-get install libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 libxtst6 xauth xvfb
      - name: Install dependencies
        run: yarn install
      - name: Run cypress test
        env:
          TEST_ENV: ${{ matrix.test_env }}
        run: ./run-tests-in-parallel.sh